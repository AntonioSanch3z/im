- hosts: localhost
  connection: local
  tasks:
    - name: Yum install epel-release
      action: yum pkg=epel-release state=installed
      when: ansible_os_family == "RedHat"

    - name: Yum install requisites
      action: yum pkg=git,gcc,python-devel,python-pip,SOAPpy,python-requests,MySQL-python,libffi-devel,openssl-devel,unzip state=installed
      when: ansible_os_family == "RedHat"

    - name: Apt-get install requisites
      apt: pkg=git,python-pip,python-dev,python-soappy,python-mysqldb,libssl-dev,libffi-dev,unzip state=installed update_cache=yes cache_valid_time=3600
      when: ansible_os_family == "Debian"

    - name: pip upgrade setuptools
      pip: name=setuptools extra_args="-I" state=latest

    - name: pip install pbr,CherryPy and pyOpenSSL to enable HTTPS in REST API
      pip: name="pbr CherryPy pyOpenSSL" extra_args="-I" state=latest

    - name: Download tosca-parser
      git: repo=https://github.com/indigo-dc/tosca-parser dest=/tmp/tosca-parser

    - name: pip install tosca-parser
      pip: name=/tmp/tosca-parser

    - name: Download IM
      git: repo=https://github.com/indigo-dc/im dest=/tmp/im

    - name: pip install IM
      pip: name=/tmp/im

################################################ Configure Ansible  ###################################################

    - name: Create /etc/ansible
      file: path=/etc/ansible state=directory
      
    - name: Set host_key_checking to false in ansible.cfg
      ini_file: dest=/etc/ansible/ansible.cfg section=defaults option=host_key_checking value=False

    - name: Set transport to ssh in ansible.cfg
      ini_file: dest=/etc/ansible/ansible.cfg section=defaults option=transport value=ssh
      when: ansible_os_family == "Debian" or (ansible_os_family == "RedHat" and ansible_distribution_major_version >= 6)  or (ansible_os_family == "Suse" and ansible_distribution_major_version >= 10)
      
    - name: Set transport to smart in ansible.cfg
      ini_file: dest=/etc/ansible/ansible.cfg section=defaults option=transport value=smart
      when: (ansible_os_family == "RedHat" and ansible_distribution_major_version < 6) or (ansible_os_family == "Suse" and ansible_distribution_major_version < 10)

    - name: Change ssh_args to set ControlPersist to 15 min in ansible.cfg
      ini_file: dest=/etc/ansible/ansible.cfg section=ssh_connection option=ssh_args value="-o ControlMaster=auto -o ControlPersist=900s"
      when: ansible_os_family == "Debian" or (ansible_os_family == "RedHat" and ansible_distribution_major_version >= 7) or (ansible_os_family == "Suse" and ansible_distribution_major_version >= 12)
      
    - name: Change ssh_args to remove ControlPersist in REL 6 and older in ansible.cfg
      ini_file: dest=/etc/ansible/ansible.cfg section=ssh_connection option=ssh_args value=""
      when: (ansible_os_family == "RedHat" and ansible_distribution_major_version < 7) or (ansible_os_family == "Suse" and ansible_distribution_major_version < 12)
      
    - name: Activate SSH pipelining in ansible.cfg
      ini_file: dest=/etc/ansible/ansible.cfg section=ssh_connection option=pipelining value=True